<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <title>Apuestas</title>
  </head>
  <body>
    <!-- Modal -->
    <div
      class="modal fade"
      id="playersModal"
      tabindex="-1"
      aria-labelledby="playersModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="playersModalLabel">Jugadores</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <!-- This is where the players' information will be loaded -->
            <p id="playersInfo">Cargando Jugadores...</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="container mt-5">
      <div class="row">
        <div class="col-12 text-center">
          <h1>Apostadores</h1>

          <!-- Buttons row -->
          <div class="d-flex justify-content-center mb-4">
            <button
              class="btn btn-success mx-2"
              id="generateCuartosBtn"
              style="background-color: lightslategrey"
            >
              Generar Clasificación Cuartos
            </button>
            <button
              class="btn btn-warning mx-2"
              id="generateSemisBtn"
              style="background-color: lightslategrey"
            >
              Generar Clasificación Semifinales
            </button>
            <button
              class="btn btn-danger mx-2"
              id="generateResultsBtn"
              style="background-color: lightslategrey"
            >
              Generar Resultados de Apostadores
            </button>
          </div>

          <ul id="betsList" class="list-group mt-4"></ul>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
      import {
        getFirestore,
        getDoc,
        collection,
        getDocs,
        query,
        where,
        doc,
        setDoc,
        writeBatch,
      } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";
      import { firebaseConfig } from "./firebaseConfig.js";

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Function to get the active tournament ID
      const getActiveTournamentId = async () => {
        const q = query(collection(db, "I_Torneos"), where("activo", "==", 1));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
          return querySnapshot.docs[0].id;
        } else {
          console.error("No active tournament found.");
          return null;
        }
      };

      const getUserNameById = async (userId) => {
        const userDocRef = doc(db, "I_Members", userId);
        const userDoc = await getDoc(userDocRef);
        if (userDoc.exists()) {
          return userDoc.data().firstName + " " + userDoc.data().lastName;
        } else {
          console.error(`No user found with ID: ${userId}`);
          return "Unknown User";
        }
      };

      const getPlayerNameById = async (playerId, tournamentId) => {
        const playersCollectionRef = collection(
          db,
          "I_Torneos",
          tournamentId,
          "I_Players"
        );
        const q = query(
          playersCollectionRef,
          where("id_player", "==", playerId)
        );
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
          const playerDoc = querySnapshot.docs[0]; // Assuming playerId is unique and only one document matches
          return playerDoc.data().name;
        } else {
          console.error(`No player found with ID: ${playerId}`);
          return "Unknown Player";
        }
      };
      const getPlayersById = async (tournamentId, userId) => {
        const betDocRef = doc(
          db,
          "I_Torneos",
          tournamentId,
          "I_Apuestas",
          userId
        );

        const betDoc = await getDoc(betDocRef);

        if (betDoc.exists()) {
          const betData = betDoc.data();
          let playerDetails = "";

          for (let i = 1; i <= 8; i++) {
            const playerId = betData[`player${i}`];

            if (playerId) {
              const playerName = await getPlayerNameById(
                playerId,
                tournamentId
              );
              playerDetails += `<p>Player ${i}: ${playerName}</p>`;
            }
          }
          const playersInfoElement = document.getElementById("playersInfo");
          playersInfoElement.innerHTML = playerDetails;
        } else {
          console.error(`No bet data found for user ID: ${userId}`);
          document.getElementById("playersInfo").innerHTML =
            "No bet data found.";
        }
      };

      // Function to fetch and display bets data
      const fetchBets = async () => {
        const betsList = document.getElementById("betsList");
        betsList.innerHTML = ""; // Clear any existing data

        try {
          const activeTournament = await getActiveTournamentId();
          if (!activeTournament) {
            betsList.innerHTML =
              "<li class='list-group-item text-danger'>No active tournament found</li>";
            return;
          }

          const betsCollection = collection(
            db,
            "I_Torneos",
            activeTournament,
            "I_Apuestas"
          );

          const querySnapshot = await getDocs(betsCollection);
          const usersDisplayed = new Set(); // To avoid displaying duplicate user names

          for (const betDoc of querySnapshot.docs) {
            const userName = await getUserNameById(betDoc.id);

            // Check if the user name has already been displayed
            if (!usersDisplayed.has(userName)) {
              const listItem = document.createElement("li");
              listItem.className = "list-group-item";

              // Create a button for each user name
              const userButton = document.createElement("button");
              userButton.className = "btn btn-primary w-100"; // Styling the button
              userButton.textContent = `User Name: ${userName}`;

              // Set up the button click to trigger the modal
              userButton.addEventListener("click", async () => {
                // Here you would load the player's information into the modal, for now just show the modal
                const modal = new bootstrap.Modal(
                  document.getElementById("playersModal")
                );
                modal.show();

                await getPlayersById(activeTournament, betDoc.id);
              });

              // Append the button to the list item
              listItem.appendChild(userButton);
              betsList.appendChild(listItem);

              usersDisplayed.add(userName); // Add the user name to the set
            }
          }
        } catch (error) {
          console.error("Error fetching bets: ", error);
          betsList.innerHTML =
            "<li class='list-group-item text-danger'>Failed to load data</li>";
        }
      };

      const clasification_cuartos_buttos =
        document.getElementById("generateCuartosBtn");
      clasification_cuartos_buttos.addEventListener("click", async () => {
        const activeTournament = await getActiveTournamentId();
        if (!activeTournament) {
          console.error("No active tournament found.");
          return;
        }
        await processClasificacionCuartos(activeTournament);
        console.log("Clasificacion Cuartos generated successfully.");
      });

      const processClasificacionCuartos = async (tournamentId) => {
        // Fetch all players in I_Cuartos
        console.log("Fetching players from I_Cuartos...");
        const cuartosCollection = collection(
          db,
          "I_Torneos",
          tournamentId,
          "I_Cuartos"
        );

        const cuartosSnapshot = await getDocs(cuartosCollection);
        const cuartosPlayers = cuartosSnapshot.docs.map(
          (doc) => doc.data().id_player
        );

        // Fetch all users in I_Apuestas
        console.log("Fetching all users from I_Apuestas...");
        const apuestasCollection = collection(
          db,
          "I_Torneos",
          tournamentId,
          "I_Apuestas"
        );
        const apuestasSnapshot = await getDocs(apuestasCollection);

        // Prepare the I_Clasificacion_Cuartos collection
        const clasificacionCollection = collection(
          db,
          "I_Torneos",
          tournamentId,
          "I_Clasificacion_Cuartos"
        );
        const batch = writeBatch(db);

        for (const apuestaDoc of apuestasSnapshot.docs) {
          const apuestaData = apuestaDoc.data();
          const matchingPlayers = [];

          // Fetch the user's name
          const userName = await getUserNameById(apuestaDoc.id);

          // Check how many of the players in this user's bet are in I_Cuartos
          for (let i = 1; i <= 8; i++) {
            const playerId = apuestaData[`player${i}`];

            if (cuartosPlayers.includes(playerId)) {
              // Fetch the player's name
              const playerName = await getPlayerNameById(
                playerId,
                tournamentId
              );

              matchingPlayers.push({ playerId, playerName });
            }
          }

          // If there are at least two matching players, add them to I_Clasificacion_Cuartos
          if (matchingPlayers.length >= 2) {
            const clasificacionDocRef = doc(
              clasificacionCollection,
              apuestaDoc.id
            ); // Using userId as the document ID
            batch.set(clasificacionDocRef, {
              userId: apuestaDoc.id,
              userName: userName,
              players: matchingPlayers, // Array of objects with playerId and playerName
            });
          } else {
          }
        }

        // Commit the batch operation

        await batch.commit();
      };

      const clasification_semis_buttos =
        document.getElementById("generateSemisBtn");
      clasification_semis_buttos.addEventListener("click", async () => {
        const activeTournament = await getActiveTournamentId();
        if (!activeTournament) {
          console.error("No active tournament found.");
          return;
        }
        await processClasificacionSemis(activeTournament);
        console.log("Clasificacion Semis generated successfully.");
      });

      const processClasificacionSemis = async (tournamentId) => {
        // Fetch all players in I_Semifinales
        console.log("Fetching players from I_Semifinales...");
        const semisCollection = collection(
          db,
          "I_Torneos",
          tournamentId,
          "I_Semifinales"
        );

        const semisSnapshot = await getDocs(semisCollection);
        const semisPlayers = semisSnapshot.docs.map(
          (doc) => doc.data().id_player
        );

        // Fetch all users in I_Apuestas
        console.log("Fetching all users from I_Apuestas...");
        const apuestasCollection = collection(
          db,
          "I_Torneos",
          tournamentId,
          "I_Apuestas"
        );
        const apuestasSnapshot = await getDocs(apuestasCollection);

        // Prepare the I_Clasificacion_Semis collection
        const clasificacionSemisCollection = collection(
          db,
          "I_Torneos",
          tournamentId,
          "I_Clasificacion_Semis"
        );
        const batch = writeBatch(db);

        for (const apuestaDoc of apuestasSnapshot.docs) {
          const apuestaData = apuestaDoc.data();
          const matchingPlayers = [];

          // Fetch the user's name
          const userName = await getUserNameById(apuestaDoc.id);

          // Check how many of the players in this user's bet are in I_Semifinales
          for (let i = 1; i <= 8; i++) {
            const playerId = apuestaData[`player${i}`];

            if (semisPlayers.includes(playerId)) {
              // Fetch the player's name
              const playerName = await getPlayerNameById(
                playerId,
                tournamentId
              );

              matchingPlayers.push({ playerId, playerName });
            }
          }

          // If there is at least one matching player, add them to I_Clasificacion_Semis
          if (matchingPlayers.length >= 1) {
            const clasificacionDocRef = doc(
              clasificacionSemisCollection,
              apuestaDoc.id
            ); // Using userId as the document ID
            batch.set(clasificacionDocRef, {
              userId: apuestaDoc.id,
              userName: userName,
              players: matchingPlayers, // Array of objects with playerId and playerName
            });
          }
        }

        // Commit the batch operation
        await batch.commit();
        console.log("Clasificacion Semis processing completed.");
      };

      // Fetch bets data on page load
      fetchBets();
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
